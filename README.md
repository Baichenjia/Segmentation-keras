# Segmentation-keras
Keras implementation of "Multi-scale context aggregation by dilated convolutions (ICLR 2016)" 

## 导入预训练的权重
从网址 `http://imagelab.ing.unimore.it/files/dilation_keras/cityscapes.h5` 中下载权重，存储到 `~/.keras/models/` 目录下.

## 运行
在 predict.py 中 main 函数中指定要预测的图像文件名 fname，运行 python predict.py 即可。

## 网络结构
网络结构定义在 dilation_net.py 中，输入为 (3,1396,1396)，输出为(19,1024,1024)。因为该数据集含有19个类别，
因此在通道层面进行输出即可得到对每个类别的概率，取最大值得到类别。
模型中包含 卷积、空洞卷积、Dropout、Pooling、Padding、上采样等操作，具体模型结构为：
```
_________________________________________________________________
Layer (type)                 Output Shape              Param    
=================================================================
input_1 (InputLayer)         (None, 3, 1396, 1396)     0         
_________________________________________________________________
conv1_1 (Conv2D)             (None, 64, 1394, 1394)    1792      
_________________________________________________________________
conv1_2 (Conv2D)             (None, 64, 1392, 1392)    36928     
_________________________________________________________________
pool1 (MaxPooling2D)         (None, 64, 696, 696)      0         
_________________________________________________________________
conv2_1 (Conv2D)             (None, 128, 694, 694)     73856     
_________________________________________________________________
conv2_2 (Conv2D)             (None, 128, 692, 692)     147584    
_________________________________________________________________
pool2 (MaxPooling2D)         (None, 128, 346, 346)     0         
_________________________________________________________________
conv3_1 (Conv2D)             (None, 256, 344, 344)     295168    
_________________________________________________________________
conv3_2 (Conv2D)             (None, 256, 342, 342)     590080    
_________________________________________________________________
conv3_3 (Conv2D)             (None, 256, 340, 340)     590080    
_________________________________________________________________
pool3 (MaxPooling2D)         (None, 256, 170, 170)     0         
_________________________________________________________________
conv4_1 (Conv2D)             (None, 512, 168, 168)     1180160   
_________________________________________________________________
conv4_2 (Conv2D)             (None, 512, 166, 166)     2359808   
_________________________________________________________________
conv4_3 (Conv2D)             (None, 512, 164, 164)     2359808   
_________________________________________________________________
conv5_1 (Conv2D)             (None, 512, 160, 160)     2359808   
_________________________________________________________________
conv5_2 (Conv2D)             (None, 512, 156, 156)     2359808   
_________________________________________________________________
conv5_3 (Conv2D)             (None, 512, 152, 152)     2359808   
_________________________________________________________________
fc6 (Conv2D)                 (None, 4096, 128, 128)    102764544 
_________________________________________________________________
drop6 (Dropout)              (None, 4096, 128, 128)    0         
_________________________________________________________________
fc7 (Conv2D)                 (None, 4096, 128, 128)    16781312  
_________________________________________________________________
drop7 (Dropout)              (None, 4096, 128, 128)    0         
_________________________________________________________________
final (Conv2D)               (None, 19, 128, 128)      77843     
_________________________________________________________________
ctx_conv1_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
ctx_conv1_2 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_1 (ZeroPaddin (None, 19, 132, 132)      0         
_________________________________________________________________
ctx_conv2_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_2 (ZeroPaddin (None, 19, 136, 136)      0         
_________________________________________________________________
ctx_conv3_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_3 (ZeroPaddin (None, 19, 144, 144)      0         
_________________________________________________________________
ctx_conv4_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_4 (ZeroPaddin (None, 19, 160, 160)      0         
_________________________________________________________________
ctx_conv5_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_5 (ZeroPaddin (None, 19, 192, 192)      0         
_________________________________________________________________
ctx_conv6_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_6 (ZeroPaddin (None, 19, 256, 256)      0         
_________________________________________________________________
ctx_conv7_1 (Conv2D)         (None, 19, 128, 128)      3268      
_________________________________________________________________
zero_padding2d_7 (ZeroPaddin (None, 19, 130, 130)      0         
_________________________________________________________________
ctx_fc1 (Conv2D)             (None, 19, 128, 128)      3268      
_________________________________________________________________
ctx_final (Conv2D)           (None, 19, 128, 128)      380       
_________________________________________________________________
up_sampling2d_1 (UpSampling2 (None, 19, 1024, 1024)    0         
_________________________________________________________________
ctx_upsample (Conv2D)        (None, 19, 1024, 1024)    92416     
_________________________________________________________________
permute_1 (Permute)          (None, 1024, 1024, 19)    0         
_________________________________________________________________
reshape_1 (Reshape)          (None, 1048576, 19)       0         
_________________________________________________________________
activation_1 (Activation)    (None, 1048576, 19)       0         
_________________________________________________________________
reshape_2 (Reshape)          (None, 1024, 1024, 19)    0         
_________________________________________________________________
permute_2 (Permute)          (None, 19, 1024, 1024)    0         
=================================================================
Total params: 134,460,595
Trainable params: 134,368,179
Non-trainable params: 92,416
```

##结果示例

![示例1](/imgs_test/fig1-res.png "")
![示例2](/imgs_test/fig2-res.png "")
![示例3](/imgs_test/fig3-res.png "")
![示例4](/imgs_test/fig4-res.png "")









